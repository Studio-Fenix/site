<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Treinos - Studio Fenix</title>
    <link rel="icon" type="image/webp" href="icon.webp">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* DARK MODE */
            --bg-gradient: linear-gradient(to bottom, #0a0a0a 0%, #1a1a1a 40%, #800000 100%);
            --text-color: #ffffff;
            --glass-bg: linear-gradient(135deg, rgba(255, 50, 50, 0.15), rgba(100, 0, 0, 0.4));
            --glass-border: rgba(255, 200, 200, 0.25);
            --glass-highlight: rgba(255, 255, 255, 0.3);
            --glass-shadow: 0 8px 32px rgba(0,0,0,0.5);
            --btn-text: #ffffff;
            --highlight-green: #00ff88;
        }
        
        body.light-mode {
            /* LIGHT MODE */
            --bg-gradient: linear-gradient(to bottom, #f4f4f4 0%, #e0e0e0 50%, #ff9999 100%);
            --text-color: #333333;
            --glass-bg: linear-gradient(135deg, rgba(220, 50, 50, 0.6), rgba(180, 0, 0, 0.7));
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-highlight: rgba(255, 255, 255, 0.8);
            --glass-shadow: 0 8px 32px rgba(150, 0, 0, 0.2);
            --highlight-green: #00a650;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg-gradient); min-height: 100vh; display: flex; flex-direction: column;
            align-items: center; color: var(--text-color); padding: 20px; padding-bottom: 90px;
        }

        .container { width: 100%; max-width: 480px; display: flex; flex-direction: column; gap: 20px; }
        
        .header-nav { width: 100%; display: flex; justify-content: center; margin-bottom: 10px; }
        .logo { width: 160px; display: block; filter: drop-shadow(0 0 15px rgba(255,0,0,0.4)); }
        
        .glass-card {
            background: var(--glass-bg); backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border); border-top: 1px solid var(--glass-highlight);
            border-radius: 20px; padding: 25px; box-shadow: var(--glass-shadow); text-align: center;
            animation: fadeIn 0.4s ease; position: relative;
        }

        .input-group { margin-bottom: 15px; text-align: left; }
        label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #ccc; }
        input { 
            width: 100%; padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.3); color: white; font-size: 1rem; outline: none;
        }

        /* BOTÕES GERAIS */
        .btn {
            width: 100%; padding: 15px; border-radius: 12px; border: none; color: white;
            font-weight: 700; font-size: 1rem; cursor: pointer; text-transform: uppercase;
            transition: transform 0.2s, box-shadow 0.3s; margin-top: 10px; display: flex;
            align-items: center; justify-content: center; gap: 10px; text-decoration: none;
        }
        .btn:active { transform: scale(0.95); }
        .btn-outline { background: transparent; border: 2px solid rgba(255,255,255,0.2); color: #ddd; }
        .btn-red { background: linear-gradient(90deg, #cc0000, #ff4444); box-shadow: 0 4px 15px rgba(255,0,0,0.3); }

        /* GRID OBJETIVOS E CRONOGRAMA */
        .grid-list { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .option-btn {
            padding: 15px; background: rgba(0,0,0,0.4); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
            color: #ddd; cursor: pointer; text-align: center; transition: all 0.2s; font-weight: 600; text-transform: uppercase;
        }
        .option-btn:active { background: #333; }

        .week-schedule { display: flex; flex-direction: column; gap: 5px; margin-bottom: 20px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 15px; text-align: left; }
        .day-row { display: flex; justify-content: space-between; font-size: 0.8rem; color: #aaa; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .day-row:last-child { border-bottom: none; }
        .day-row.active { color: var(--highlight-green); font-weight: 800; font-size: 0.9rem; text-shadow: 0 0 8px rgba(0,255,136,0.4); }

        /* CARROSSEL PREVIEW */
        .preview-carousel {
            display: flex; gap: 15px; overflow-x: auto; scroll-snap-type: x mandatory;
            padding-bottom: 10px; margin-top: 15px; scrollbar-width: none;
        }
        .preview-carousel::-webkit-scrollbar { display: none; }
        .preview-card {
            min-width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px; overflow: hidden; scroll-snap-align: center;
        }
        .preview-card img { width: 100%; height: 180px; object-fit: cover; }
        .preview-card-info { padding: 15px; text-align: left; }
        .preview-card-info h4 { font-size: 1.1rem; color: #fff; margin: 0 0 5px 0; text-transform: uppercase; }
        .preview-card-info p { font-size: 0.85rem; color: #aaa; margin: 0; }
        .swipe-hint { font-size: 0.75rem; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; text-align: right; }

        /* NOVO DESIGN: TREINO PERSONALIZADO */
        .filter-nav {
            display: flex; gap: 10px; overflow-x: auto; scrollbar-width: none;
            padding-bottom: 10px; margin-bottom: 15px;
        }
        .filter-nav::-webkit-scrollbar { display: none; }
        .filter-chip {
            padding: 8px 18px; border-radius: 20px; background: rgba(255,255,255,0.1);
            color: #ccc; font-size: 0.85rem; font-weight: 600; text-transform: uppercase;
            white-space: nowrap; cursor: pointer; border: 1px solid transparent; transition: 0.3s;
        }
        .filter-chip.active {
            background: linear-gradient(90deg, #cc0000, #ff4444); color: #fff;
            border-color: #ffaaaa; box-shadow: 0 4px 10px rgba(255,0,0,0.3);
        }

        .ex-select-list { display: flex; flex-direction: column; gap: 12px; padding-bottom: 20px; }
        
        .ex-select-card {
            display: flex; align-items: center; gap: 15px; background: rgba(0,0,0,0.4);
            border-radius: 15px; padding: 12px; border: 1px solid rgba(255,255,255,0.05);
            cursor: pointer; transition: all 0.2s ease; position: relative; overflow: hidden;
        }
        .ex-select-card:active { transform: scale(0.98); }
        
        .ex-select-img { width: 70px; height: 70px; border-radius: 10px; object-fit: cover; background: #222; flex-shrink: 0; }
        .ex-select-info { flex-grow: 1; text-align: left; }
        .ex-select-title { font-size: 0.95rem; font-weight: 700; color: #fff; margin-bottom: 3px; line-height: 1.2; }
        .ex-select-eq { font-size: 0.75rem; color: #aaa; text-transform: uppercase; }
        
        .check-circle {
            width: 26px; height: 26px; border-radius: 50%; border: 2px solid #666;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: 0.3s;
        }
        .check-circle svg { width: 14px; height: 14px; fill: none; stroke: #000; stroke-width: 3; stroke-linecap: round; stroke-linejoin: round; opacity: 0; transition: 0.3s; }
        
        .ex-select-card.selected { background: rgba(0, 255, 136, 0.1); border-color: var(--highlight-green); }
        .ex-select-card.selected .check-circle { background: var(--highlight-green); border-color: var(--highlight-green); }
        .ex-select-card.selected .check-circle svg { opacity: 1; }

        .fab-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 440px; background: rgba(20,20,20,0.95);
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px; padding: 15px; display: flex; align-items: center;
            justify-content: space-between; box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            z-index: 100; animation: slideUp 0.3s ease;
        }
        .fab-info { text-align: left; }
        .fab-count { font-size: 1.2rem; font-weight: 800; color: var(--highlight-green); }
        .fab-desc { font-size: 0.75rem; color: #aaa; text-transform: uppercase; }
        .btn-fab { 
            background: linear-gradient(90deg, #008000, #00cc66); border: none; padding: 12px 25px;
            border-radius: 10px; color: #fff; font-weight: 800; text-transform: uppercase; cursor: pointer; box-shadow: 0 4px 15px rgba(0,255,136,0.3);
        }

        @keyframes slideUp { from { transform: translate(-50%, 100%); } to { transform: translate(-50%, 0); } }

        /* TELA DE REVISÃO */
        .review-list { display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto; margin-bottom: 20px; padding-right: 5px; }
        .review-item {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05);
            padding: 12px 15px; border-radius: 12px; text-align: left;
        }
        .review-text h4 { font-size: 0.95rem; color: #fff; margin: 0 0 3px 0; }
        .review-text p { font-size: 0.75rem; color: #aaa; margin: 0; }
        .btn-remove { background: #ff4444; color: #fff; border: none; width: 32px; height: 32px; border-radius: 8px; font-weight: bold; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }

        /* PLAYER DE TREINO - SEQUÊNCIA UM A UM */
        .player-container {
            width: 100%; border-radius: 25px; overflow: hidden; box-shadow: var(--glass-shadow);
            animation: slideInRight 0.4s ease; position: relative; background: #000;
        }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }

        .player-img-wrapper { width: 100%; height: 35vh; position: relative; }
        .player-img-wrapper img { width: 100%; height: 100%; object-fit: cover; opacity: 0.85; }
        
        .player-progress-badge {
            position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px); padding: 5px 15px; border-radius: 20px;
            color: var(--highlight-green); font-weight: 800; font-size: 0.8rem; z-index: 2; border: 1px solid rgba(0,255,136,0.3);
        }

        .player-content {
            background: var(--glass-bg); backdrop-filter: blur(25px);
            border-top: 1px solid var(--glass-highlight); border-radius: 30px 30px 0 0;
            margin-top: -30px; padding: 25px; position: relative; z-index: 2; text-align: left;
        }

        .player-title { font-size: 1.3rem; font-weight: 800; color: #fff; text-transform: uppercase; margin-bottom: 5px; }
        .player-eq { color: #aaa; font-size: 0.85rem; text-transform: uppercase; margin-bottom: 15px; }
        
        .player-reps-box {
            background: rgba(255,255,255,0.1); padding: 12px; border-radius: 12px;
            margin-bottom: 15px; font-weight: bold; color: #00aaff; text-align: center; font-size: 0.95rem;
        }
        
        .player-desc { font-size: 0.85rem; color: #ddd; line-height: 1.5; padding-left: 10px; border-left: 3px solid #ff4444; margin-bottom: 20px; }
        
        .timer-display { font-size: 2.5rem; font-weight: 800; color: white; margin: 15px 0 25px 0; font-variant-numeric: tabular-nums; text-align: center; letter-spacing: 2px; }

        /* CONTROLES DO PLAYER */
        .controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .btn-start { background: linear-gradient(90deg, #008000, #00cc66); color: #fff; grid-column: span 2; animation: pulseGreen 1.5s infinite; font-weight: 800; }
        .btn-pause { background: linear-gradient(90deg, #cc5500, #ff8c00); color: #fff; box-shadow: 0 0 15px rgba(255,140,0,0.4); display: none; grid-column: span 2; }
        .btn-series { background: #666666; color: #fff; box-shadow: 0 0 10px rgba(255,255,255,0.2); display: none; grid-column: span 2; }
        
        .btn-nav { background: linear-gradient(90deg, #0055cc, #0088ff); color: #fff; box-shadow: 0 0 15px rgba(0,136,255,0.4); font-size: 0.85rem; }
        
        .btn-finish { background: linear-gradient(90deg, #8b0000, #ff0000); color: #fff; box-shadow: 0 0 20px rgba(255,0,0,0.6); grid-column: span 2; margin-top: 10px; }

        @keyframes pulseGreen { 0% { box-shadow: 0 0 0 0 rgba(0, 204, 102, 0.6); } 70% { box-shadow: 0 0 0 15px rgba(0, 204, 102, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 204, 102, 0); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="container" id="app"></div>

    <script src="usuarios.js"></script>
    <script src="exercicios.js"></script>

    <script>
        // ==========================================
        // ESTADO DA APLICAÇÃO
        // ==========================================
        const state = {
            screen: 'login',
            currentUser: null,
            goal: '',
            currentWorkout: [],
            customSelection: [],
            customFilter: 'Todos',
            currentExerciseIndex: 0,
            timerInterval: null,
            seconds: 0,
            seriesCount: 0
        };

        const app = document.getElementById('app');

        // ==========================================
        // FUNÇÕES AUXILIARES
        // ==========================================
        function getGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return 'Bom dia';
            if (hour < 18) return 'Boa tarde';
            return 'Boa noite';
        }

        function formatTime(totalSeconds) {
            const h = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
            const s = (totalSeconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        function getDaySchedule() {
            const day = new Date().getDay();
            if (day === 1 || day === 4) return ['peito', 'triceps', 'ombro'];
            if (day === 2 || day === 5) return ['costas', 'biceps', 'trapezio'];
            if (day === 3) return ['perna'];
            return ['cardio']; 
        }

        // ==========================================
        // RENDERIZAÇÃO CENTRALIZADA
        // ==========================================
        function render() {
            // Limpa TODO o ecrã antes de renderizar a próxima etapa
            app.innerHTML = '';
            
            if (state.screen !== 'login') {
                const header = document.createElement('div');
                header.className = 'header-nav';
                header.innerHTML = `<img src="LogoStudioFenix.png" class="logo">`;
                app.appendChild(header);
            }

            if (state.screen === 'login') renderLogin();
            else if (state.screen === 'dashboard') renderDashboard();
            else if (state.screen === 'custom_build') renderCustomBuild();
            else if (state.screen === 'custom_review') renderCustomReview();
            else if (state.screen === 'workout') renderWorkout();
            else if (state.screen === 'summary') renderSummary();
        }

        // TELA 1: LOGIN
        function renderLogin() {
            const div = document.createElement('div');
            div.className = 'glass-card';
            div.innerHTML = `
                <img src="LogoStudioFenix.png" class="logo" style="margin: 0 auto 20px auto;">
                <h2 style="margin-bottom:20px; text-transform:uppercase;">Acesso ao Treino</h2>
                <div class="input-group">
                    <label>Nome do Aluno</label>
                    <input type="text" id="userInput">
                </div>
                <div class="input-group">
                    <label>Senha</label>
                    <input type="password" id="passInput">
                </div>
                <button class="btn btn-red" onclick="handleLogin()">ENTRAR</button>
                <a href="index.html" class="btn btn-outline" style="margin-top:15px;">VOLTAR PARA O INÍCIO</a>
            `;
            app.appendChild(div);
        }

        // TELA 2: DASHBOARD (SELEÇÃO DE OBJETIVO E PREVIEW)
        function renderDashboard() {
            const d = new Date().getDay();
            const div = document.createElement('div');
            
            let carouselHtml = '';
            if(state.currentWorkout.length > 0) {
                state.currentWorkout.forEach((ex, idx) => {
                    carouselHtml += `
                        <div class="preview-card">
                            <img src="${ex.img}">
                            <div class="preview-card-info">
                                <h4>${idx+1}. ${ex.nome}</h4>
                                <p>${ex.musculo.toUpperCase()}</p>
                            </div>
                        </div>
                    `;
                });
                
                carouselHtml = `
                    <div class="glass-card" style="margin-top:20px; padding:20px;">
                        <h3 style="font-size:1.1rem; color:#fff; text-transform:uppercase;">${state.goal}</h3>
                        <p style="font-size:0.8rem; color:#aaa;">Prévia gerada para hoje</p>
                        <div class="preview-carousel">
                            ${carouselHtml}
                        </div>
                        <div class="swipe-hint">Deslize lateralmente para ver a série</div>
                        <button class="btn btn-start" style="margin-top:15px;" onclick="startWorkout()">COMEÇAR TREINO</button>
                    </div>
                `;
            }

            div.innerHTML = `
                <div class="glass-card" style="margin-bottom:20px; padding:20px;">
                    <h2 style="color:var(--highlight-green); font-weight:600; font-size:1.3rem;">${getGreeting()}, ${state.currentUser.name}!</h2>
                    <p style="color:#ccc; font-size:0.9rem; margin-top:5px;">Qual o objetivo do treino hoje?</p>
                </div>

                <div class="week-schedule">
                    <h3 style="color:#fff; font-size:0.9rem; margin-bottom:10px; text-transform:uppercase; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:5px;">Cronograma Oficial</h3>
                    <div class="day-row ${d === 1 ? 'active' : ''}"><span>Segunda</span> <span>Peito, Tríceps, Ombros</span></div>
                    <div class="day-row ${d === 2 ? 'active' : ''}"><span>Terça</span> <span>Costas, Bíceps, Trapézio</span></div>
                    <div class="day-row ${d === 3 ? 'active' : ''}"><span>Quarta</span> <span>Pernas Completas</span></div>
                    <div class="day-row ${d === 4 ? 'active' : ''}"><span>Quinta</span> <span>Peito, Tríceps, Ombros</span></div>
                    <div class="day-row ${d === 5 ? 'active' : ''}"><span>Sexta</span> <span>Costas, Bíceps, Trapézio</span></div>
                    <div class="day-row ${d === 6 ? 'active' : ''}"><span>Sábado</span> <span>Recuperação / Cardio</span></div>
                </div>

                <div class="grid-list">
                    <div class="option-btn" onclick="generateWorkout('TREINO SAÚDE')">TREINO SAÚDE</div>
                    <div class="option-btn" onclick="generateWorkout('PERDA DE PESO')">PERDA DE PESO</div>
                    <div class="option-btn" onclick="generateWorkout('MASSA MUSCULAR')">MASSA MUSCULAR</div>
                    <div class="option-btn" onclick="generateWorkout('TREINO RÁPIDO')">TREINO RÁPIDO</div>
                    <div class="option-btn" onclick="generateWorkout('TREINO FOFO')">TREINO FOFO</div>
                    <div class="option-btn" style="border:1px solid #ff4444; color:#ffaaaa;" onclick="generateWorkout('MODO FÊNIX')">MODO FÊNIX</div>
                    <div class="option-btn" style="background:rgba(255,255,255,0.1); border-color:#fff;" onclick="goToCustomBuild()">TREINO PERSONALIZADO</div>
                </div>
                
                ${carouselHtml}
            `;
            app.appendChild(div);
            
            if(state.currentWorkout.length > 0) {
                setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 100);
            }
        }

        // TELA 3: MONTAR TREINO
        function renderCustomBuild() {
            const div = document.createElement('div');
            
            const allCategories = ['Todos', ...new Set(exerciseDB.map(ex => ex.musculo))];
            
            let filtersHtml = '<div class="filter-nav">';
            allCategories.forEach(cat => {
                const isActive = state.customFilter.toLowerCase() === cat.toLowerCase() ? 'active' : '';
                filtersHtml += `<div class="filter-chip ${isActive}" onclick="setCustomFilter('${cat}')">${cat}</div>`;
            });
            filtersHtml += '</div>';

            const filteredEx = state.customFilter.toLowerCase() === 'todos' 
                ? exerciseDB 
                : exerciseDB.filter(ex => ex.musculo.toLowerCase() === state.customFilter.toLowerCase());

            let listHtml = '<div class="ex-select-list">';
            filteredEx.forEach(ex => {
                const isSelected = state.customSelection.some(item => item.id === ex.id);
                listHtml += `
                    <div class="ex-select-card ${isSelected ? 'selected' : ''}" onclick="toggleCustom('${ex.id}')">
                        <img src="${ex.img}" class="ex-select-img">
                        <div class="ex-select-info">
                            <div class="ex-select-title">${ex.nome}</div>
                            <div class="ex-select-eq">${ex.eq}</div>
                        </div>
                        <div class="check-circle">
                            <svg viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>
                        </div>
                    </div>
                `;
            });
            listHtml += '</div>';

            div.innerHTML = `
                <div class="glass-card" style="margin-bottom:15px; padding:20px;">
                    <h2 style="font-size:1.3rem; text-transform:uppercase;">Montar Treino</h2>
                    <p style="font-size:0.85rem; color:#aaa; margin-top:5px;">Selecione os exercícios desejados</p>
                </div>
                
                ${filtersHtml}
                
                <div style="padding-bottom:20px;">
                    ${listHtml}
                </div>
            `;
            
            const fab = document.createElement('div');
            fab.className = 'fab-bar';
            fab.innerHTML = `
                <div class="fab-info">
                    <div class="fab-count">${state.customSelection.length}</div>
                    <div class="fab-desc">Selecionados</div>
                </div>
                <button class="btn-fab" onclick="goToCustomReview()">Revisar</button>
            `;

            app.appendChild(div);
            if(state.customSelection.length > 0) app.appendChild(fab);
        }

        // TELA 3.5: REVISÃO DO TREINO PERSONALIZADO
        function renderCustomReview() {
            const div = document.createElement('div');
            div.className = 'glass-card';
            
            let reviewHtml = '<div class="review-list">';
            if(state.customSelection.length === 0) {
                reviewHtml += '<p style="color:#aaa; text-align:center;">Nenhum exercício selecionado.</p>';
            } else {
                state.customSelection.forEach((ex, index) => {
                    reviewHtml += `
                        <div class="review-item">
                            <div class="review-text">
                                <h4>${index + 1}. ${ex.nome}</h4>
                                <p>${ex.eq}</p>
                            </div>
                            <button class="btn-remove" onclick="removeCustomEx('${ex.id}')">X</button>
                        </div>
                    `;
                });
            }
            reviewHtml += '</div>';

            div.innerHTML = `
                <h2 style="text-transform:uppercase; margin-bottom:5px;">Sua Seleção</h2>
                <p style="font-size:0.85rem; color:#aaa; margin-bottom:20px;">Revise a ordem antes de iniciar</p>
                
                ${reviewHtml}

                <button class="btn btn-start" onclick="startCustomWorkout()">INICIAR TREINO</button>
                <button class="btn btn-outline" onclick="state.screen = 'custom_build'; render();">ADICIONAR MAIS</button>
            `;
            app.appendChild(div);
        }

        // TELA 4: PLAYER DO TREINO (UM A UM SEQUENCIAL)
        function renderWorkout() {
            const ex = state.currentWorkout[state.currentExerciseIndex];
            
            let repsInfo = "3 Séries | 12 a 15 Reps";
            if(state.goal === "TREINO SAÚDE") repsInfo = "3 Séries | 15 Reps (Carga Leve)";
            if(state.goal === "PERDA DE PESO") repsInfo = "4 Séries | 15 a 20 Reps (Intenso)";
            if(state.goal === "MASSA MUSCULAR") repsInfo = "4 Séries | 8 a 12 Reps (Pesado)";
            if(state.goal === "TREINO RÁPIDO") repsInfo = "2 Séries | 15 Reps (Sem Descanso)";
            if(state.goal === "TREINO FOFO") repsInfo = "2 Séries | 10 Reps (Muito Leve)";
            if(state.goal === "MODO FÊNIX") repsInfo = "4 Séries | Até a falha";
            if(state.goal === "TREINO PERSONALIZADO") repsInfo = "Séries e Repetições Livres";

            const div = document.createElement('div');
            div.className = 'player-container';
            
            div.innerHTML = `
                <div class="player-img-wrapper">
                    <div class="player-progress-badge">EXERCÍCIO ${state.currentExerciseIndex + 1} / ${state.currentWorkout.length}</div>
                    <img src="${ex.img}" alt="${ex.nome}">
                </div>
                <div class="player-content">
                    <div class="player-title">${ex.nome}</div>
                    <div class="player-eq">${ex.eq}</div>
                    
                    <div class="player-reps-box">
                        ${repsInfo}
                    </div>

                    <div class="player-desc">
                        ${ex.desc}
                    </div>

                    <div class="timer-display" id="timerDisplay">00:00:00</div>
                    
                    <div class="controls-grid">
                        <button class="btn btn-start" id="btnStart" onclick="toggleTimer(true)">COMEÇAR</button>
                        <button class="btn btn-pause" id="btnPause" onclick="toggleTimer(false)">PAUSA</button>
                        <button class="btn btn-series" id="btnSeries" onclick="addSeries()">SÉRIE CONCLUÍDA (<span id="seriesVal">0</span>)</button>
                        
                        <button class="btn btn-nav" onclick="prevExercise()">VOLTAR</button>
                        <button class="btn btn-nav" onclick="nextExercise()">PRÓXIMO</button>
                        
                        <button class="btn btn-finish" onclick="finishWorkout()">FINALIZAR TREINO</button>
                    </div>
                </div>
            `;
            app.appendChild(div);
            
            document.getElementById('timerDisplay').innerText = formatTime(state.seconds);
            
            // Re-aplica visual do timer caso esteja a correr ao mudar de ecrã
            if (state.timerInterval) {
                document.getElementById('btnStart').style.display = 'none';
                document.getElementById('btnPause').style.display = 'block';
                document.getElementById('btnSeries').style.display = 'block';
            }
        }

        // TELA 5: RESUMO FINAL
        function renderSummary() {
            const messages = ["TREINO CONCLUÍDO!", "TREINO PAGO!", "TREINO FEITO COM SUCESSO!"];
            const randomMsg = messages[Math.floor(Math.random() * messages.length)];
            const timeFormat = formatTime(state.seconds);

            const div = document.createElement('div');
            div.className = 'glass-card';
            div.innerHTML = `
                <h1 style="color:var(--highlight-green); margin-bottom:10px; font-size:1.6rem; line-height:1.2;">${randomMsg}</h1>
                <p style="color:#fff; margin-bottom:20px;">Você finalizou o <strong>${state.goal}</strong>.</p>
                
                <div style="background:rgba(255,255,255,0.1); padding:25px 20px; border-radius:15px; margin-bottom:20px;">
                    <h2 style="color:#fff; font-size:2.8rem; margin-bottom:5px;">${timeFormat}</h2>
                    <p style="font-size:0.8rem; color:#aaa; text-transform:uppercase; letter-spacing:1px;">Tempo Total Gasto</p>
                </div>

                <a href="foto.html" class="btn btn-nav" style="margin-bottom:10px;">COMPARTILHAR</a>
                <button class="btn btn-outline" onclick="resetApp()">ESCOLHER OUTRO TREINO</button>
            `;
            app.appendChild(div);
        }

        // ==========================================
        // LÓGICA DE NAVEGAÇÃO E AÇÕES
        // ==========================================

        function handleLogin() {
            if(typeof usersDB === 'undefined') {
                alert("Erro: O arquivo 'usuarios.js' não foi encontrado.");
                return;
            }

            const u = document.getElementById('userInput').value.toLowerCase().trim();
            const p = document.getElementById('passInput').value;
            
            const userMatch = usersDB.find(user => user.user === u && user.pass === p);
            
            if (userMatch) {
                state.currentUser = userMatch;
                state.screen = 'dashboard';
                render();
            } else {
                alert('Nome de usuário ou senha incorretos.');
            }
        }

        function generateWorkout(goalType) {
            if(typeof exerciseDB === 'undefined') {
                alert("Erro: O arquivo 'exercicios.js' não foi encontrado.");
                return;
            }

            state.goal = goalType;
            state.seconds = 0;
            state.seriesCount = 0;
            clearInterval(state.timerInterval);
            state.timerInterval = null;

            const targetMuscles = getDaySchedule();
            let availableExercises = exerciseDB.filter(ex => targetMuscles.includes(ex.musculo));
            
            if(availableExercises.length === 0) {
                availableExercises = exerciseDB.filter(ex => ex.musculo === 'cardio');
            }

            availableExercises.sort(() => 0.5 - Math.random());
            state.currentWorkout = availableExercises.slice(0, 5);
            
            render(); 
        }

        function goToCustomBuild() {
            if(typeof exerciseDB === 'undefined') {
                alert("Erro: O arquivo 'exercicios.js' não foi encontrado.");
                return;
            }
            state.customSelection = [];
            state.customFilter = 'Todos';
            state.screen = 'custom_build';
            render();
        }

        function setCustomFilter(filter) {
            state.customFilter = filter;
            render();
        }

        function toggleCustom(id) {
            const exObj = exerciseDB.find(e => e.id === id);
            const exists = state.customSelection.some(e => e.id === id);

            if (exists) {
                state.customSelection = state.customSelection.filter(e => e.id !== id);
            } else {
                state.customSelection.push(exObj);
            }
            render(); 
        }

        function goToCustomReview() {
            state.screen = 'custom_review';
            render();
        }

        function removeCustomEx(id) {
            state.customSelection = state.customSelection.filter(e => e.id !== id);
            if(state.customSelection.length === 0) {
                state.screen = 'custom_build';
            }
            render();
        }

        function startCustomWorkout() {
            if (state.customSelection.length === 0) return;
            state.goal = "TREINO PERSONALIZADO";
            state.currentWorkout = state.customSelection;
            state.currentExerciseIndex = 0;
            state.seconds = 0;
            state.seriesCount = 0;
            clearInterval(state.timerInterval);
            state.timerInterval = null;
            state.screen = 'workout';
            render();
        }

        function startWorkout() {
            state.currentExerciseIndex = 0;
            state.seconds = 0;
            state.seriesCount = 0;
            clearInterval(state.timerInterval);
            state.timerInterval = null;
            state.screen = 'workout';
            render();
        }

        function toggleTimer(start) {
            const btnStart = document.getElementById('btnStart');
            const btnPause = document.getElementById('btnPause');
            const btnSeries = document.getElementById('btnSeries');

            if (start) {
                btnStart.style.display = 'none';
                btnPause.style.display = 'block';
                btnSeries.style.display = 'block';
                
                state.timerInterval = setInterval(() => {
                    state.seconds++;
                    document.getElementById('timerDisplay').innerText = formatTime(state.seconds);
                }, 1000);
            } else {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
                btnStart.innerText = "CONTINUAR";
                btnStart.style.display = 'block';
                btnPause.style.display = 'none';
            }
        }

        function addSeries() {
            state.seriesCount++;
            document.getElementById('seriesVal').innerText = state.seriesCount;
        }

        function nextExercise() {
            if (state.currentExerciseIndex < state.currentWorkout.length - 1) {
                state.currentExerciseIndex++;
                state.seriesCount = 0;
                render(); // Limpa e mostra apenas o novo exercício na tela
            } else {
                finishWorkout();
            }
        }

        function prevExercise() {
            if (state.currentExerciseIndex > 0) {
                state.currentExerciseIndex--;
                state.seriesCount = 0;
                render(); // Limpa e volta à tela do exercício anterior
            }
        }

        function finishWorkout() {
            clearInterval(state.timerInterval);
            state.timerInterval = null;
            state.screen = 'summary';
            render();
        }

        function resetApp() {
            state.goal = '';
            state.currentWorkout = [];
            state.seconds = 0;
            clearInterval(state.timerInterval);
            state.timerInterval = null;
            state.screen = 'dashboard';
            render();
        }

        // Inicializa o app
        render();

    </script>
</body>
</html>